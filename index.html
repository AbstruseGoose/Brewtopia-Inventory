<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brewtopia Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- QUAGGA2 (WASM/JS) -->
  <script src="./quagga/quagga.min.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg-body: #0d1117;
      --bg-card: rgba(22, 27, 34, 0.92);
      --bg-card-soft: rgba(22, 27, 34, 0.6);
      --border-subtle: #30363d;
      --text-primary: #e6edf3;
      --text-muted: #8b949e;
      --accent: #2f81f7;
      --accent-soft: rgba(47, 129, 247, 0.2);

      --cat-syrup: rgba(244, 114, 182, 0.18);
      --cat-syrup-border: rgba(244, 114, 182, 0.6);
      --cat-milk: rgba(56, 189, 248, 0.18);
      --cat-milk-border: rgba(56, 189, 248, 0.6);
      --cat-topping: rgba(251, 191, 36, 0.18);
      --cat-topping-border: rgba(251, 191, 36, 0.6);
      --cat-cup: rgba(52, 211, 153, 0.18);
      --cat-cup-border: rgba(52, 211, 153, 0.6);
      --cat-other: rgba(148, 163, 184, 0.18);
      --cat-other-border: rgba(148, 163, 184, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #161b22 0, #0d1117 55%, #020409 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 920px;
      margin: 0 auto;
    }

    h1, h2, h3 {
      margin: 0 0 0.3rem;
      font-weight: 600;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 18px;
      margin-bottom: 16px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      backdrop-filter: blur(18px);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #238636, #2ea043);
      color: #f0fdf4;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 8px 18px rgba(34,197,94,0.35);
      transition: 0.1s ease;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #21262d, #161b22);
      color: var(--text-primary);
      border-color: #30363d;
    }

    .hidden { display:none; }

    /******** Camera Window Fix ********/

    .video-wrapper {
      position: relative;
      background: #000;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid #30363d;
      width: 100%;
      height: 240px;
      max-height: 240px;
    }

    .video-wrapper video, 
    .video-wrapper canvas {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }

    .scan-overlay {
      position: absolute;
      inset: 12%;
      border: 2px solid rgba(47,129,247,0.85);
      border-radius:14px;
      pointer-events:none;
    }

  </style>
</head>
<body>
<div class="app">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h1>Brewtopia Inventory</h1>
    <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" />
    <button id="loginBtn" class="btn">Unlock</button>
    <div id="loginStatus"></div>
  </div>

  <!-- MAIN -->
  <div id="mainArea" class="hidden">
    <div class="card">
      <h2>Brewtopia Inventory</h2>
      <div>
        <button class="btn" id="btnReceive">üì¶ Receive</button>
        <button class="btn secondary" id="btnUse">ü•§ Use</button>
        <button class="btn secondary" id="btnInventory">üìã Inventory</button>
        <button class="btn secondary" id="btnExportPDF">üñ®Ô∏è Export PDF</button>
        <button class="btn secondary" id="btnExportHTML">üíæ Download HTML</button>
        <button class="btn secondary" id="btnImportHTML">üì• Import HTML</button>
        <input type="file" id="importFileInput" class="hidden" accept=".html">
      </div>
    </div>

    <!-- RECEIVE -->
    <div id="receiveCard" class="card hidden">
      <h3>Receive Stock</h3>

      <button id="startReceiveScanBtn" class="btn">üé• Start Scan</button>
      <button id="stopReceiveScanBtn" class="btn secondary hidden">Stop</button>

      <div class="video-wrapper hidden" id="receiveVideoWrapper">
        <video id="receiveVideo"></video>
        <div class="scan-overlay"></div>
      </div>

      <button id="toggleTorchReceive" class="btn secondary" style="margin-top:8px;">üí° Toggle Flash</button>

      <div id="receiveList" style="margin-top:10px;">No items scanned yet.</div>
      <button id="receiveApplyBtn" class="btn" style="margin-top:10px;">Apply</button>
    </div>

    <!-- USE -->
    <div id="useCard" class="card hidden">
      <h3>Use Item</h3>

      <button id="startUseScanBtn" class="btn">üé• Start Scan</button>
      <button id="stopUseScanBtn" class="btn secondary hidden">Stop</button>

      <div class="video-wrapper hidden" id="useVideoWrapper">
        <video id="useVideo"></video>
        <div class="scan-overlay"></div>
      </div>

      <button id="toggleTorchUse" class="btn secondary" style="margin-top:8px;">üí° Toggle Flash</button>

      <div id="useStatus" style="margin-top:10px;"></div>
    </div>

    <!-- INVENTORY -->
    <div id="inventoryCard" class="card hidden">
      <h3>Inventory</h3>
      <input id="invSearch" type="text" placeholder="Search...">
      <div id="inventoryTableWrapper" style="margin-top:10px; max-height:350px; overflow:auto;">
        <table style="width:100%;">
          <thead>
            <tr>
              <th>Item</th><th>UPC</th><th>Cat.</th><th>Qty</th><th>Par</th><th></th>
            </tr>
          </thead>
          <tbody id="inventoryBody"></tbody>
        </table>
      </div>
    </div>
    <!-- ITEM MODAL -->
    <div id="itemModalBackdrop" class="hidden" 
         style="position:fixed; inset:0; background:rgba(0,0,0,0.55); 
                display:flex; justify-content:center; align-items:center; z-index:50;">
      <div class="card" style="max-width:480px; width:100%; position:relative;">
        <h3 id="modalTitle">New Item</h3>

        <label>UPC</label>
        <input id="modalUpc" type="text" readonly>

        <label>Item Name</label>
        <input id="modalName" type="text">

        <label>Category</label>
        <select id="modalCategory">
          <option value="Syrup">Syrup</option>
          <option value="Milk">Milk</option>
          <option value="Topping">Topping</option>
          <option value="Cup">Cup</option>
          <option value="Other">Other</option>
        </select>

        <label>Size</label>
        <input id="modalSize" type="text">

        <label>Unit</label>
        <input id="modalUnit" type="text" placeholder="bottle, jug, case‚Ä¶">

        <div style="display:flex; gap:10px;">
          <div style="flex:1;">
            <label>Par</label>
            <input id="modalPar" type="number">
          </div>
          <div style="flex:1;">
            <label>Qty</label>
            <input id="modalQty" type="number">
          </div>
        </div>

        <label>Notes</label>
        <textarea id="modalNotes" rows="2"></textarea>

        <div style="display:flex; justify-content:flex-end; margin-top:10px; gap:8px;">
          <button id="modalDeleteBtn" class="btn secondary">Delete</button>
          <button id="modalCancelBtn" class="btn secondary">Cancel</button>
          <button id="modalSaveBtn" class="btn">Save</button>
        </div>

        <div id="modalStatus" style="margin-top:8px; font-size:13px;"></div>
      </div>
    </div>

</div> <!-- end .app -->

<!-- SOUND BEEP -->
<audio id="beepSound">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAAAA" type="audio/wav">
</audio>

<script>
/********************************************
 * CONFIG + STATE
 ********************************************/
const PIN = "6251";
const STORAGE_KEY = "brewtopia_inventory_v2";

let inventory = {};      // UPC ‚Üí item
let receiveScans = {};   // UPC ‚Üí count
let currentStream = null;

/********************************************
 * UTIL
 ********************************************/
const $ = id => document.getElementById(id);

function saveInventory() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify({items:inventory}));
}

function loadInventory() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    inventory = data.items || {};
  } catch(e) {
    console.error("Load error:", e);
  }
}

function vibrate(ms=50){
  if (navigator.vibrate) navigator.vibrate(ms);
}

function beep(){
  const snd = $("beepSound");
  snd.currentTime = 0;
  snd.play().catch(()=>{});
}

function isValidUPC(code) {
  if (!/^[0-9]{12}$/.test(code)) return false;
  let sum = 0;
  for (let i=0;i<11;i++){
    const n = parseInt(code[i],10);
    sum += (i%2===0) ? n*3 : n;
  }
  const check = (10 - (sum % 10)) % 10;
  return check === parseInt(code[11],10);
}

/********************************************
 * LOGIN
 ********************************************/
$("loginBtn").onclick = () => {
  if ($("pinInput").value.trim() === PIN) {
    $("loginCard").classList.add("hidden");
    $("mainArea").classList.remove("hidden");
    loadInventory();
    renderInventoryTable();
  } else {
    $("loginStatus").textContent = "Incorrect PIN";
  }
};

/********************************************
 * NAVIGATION
 ********************************************/
$("btnReceive").onclick = ()=>showSection("receive");
$("btnUse").onclick = ()=>showSection("use");
$("btnInventory").onclick = ()=>showSection("inventory");

function showSection(which){
  $("receiveCard").classList.add("hidden");
  $("useCard").classList.add("hidden");
  $("inventoryCard").classList.add("hidden");

  stopScanner();

  if (which==="receive") $("receiveCard").classList.remove("hidden");
  if (which==="use") $("useCard").classList.remove("hidden");
  if (which==="inventory") $("inventoryCard").classList.remove("hidden");
}

/********************************************
 * QUAGGA SCAN CONFIG
 ********************************************/
const quaggaConfig = {
  inputStream: {
    type: "LiveStream",
    constraints: {
      facingMode: "environment"
    },
    area: { top: "20%", right: "20%", left: "20%", bottom: "20%" }
  },
  decoder: {
    readers: [
      "ean_reader",
      "ean_8_reader",
      "upc_reader",
      "upc_e_reader"
    ],
    multiple: false
  },
  locate: true,
  frequency: 10,
  numOfWorkers: 2,
  locateFile: path => "./quagga/" + path
};

/********************************************
 * APPLY CONFIDENCE THRESHOLD
 ********************************************/
function isHighConfidence(result) {
  if (!result.codeResult || !result.codeResult.decodedCodes) return false;
  const sum = result.codeResult.decodedCodes
    .filter(c => c.error !== undefined)
    .reduce((acc,c)=>acc + c.error, 0);
  // threshold: -5 or higher is acceptable
  return sum >= -5;
}

/********************************************
 * START/STOP SCANNER
 ********************************************/
function startScanner(videoElement, overlayPurpose){
  stopScanner();

  Quagga.init(quaggaConfig, err=>{
    if (err) {
      console.error("Quagga init error", err);
      return;
    }
    Quagga.start();

    currentStream = true;

    const wrapper = videoElement.parentNode;
    wrapper.classList.remove("hidden");

    if (overlayPurpose==="receive") {
      Quagga.onDetected(data=>{
        handleScanResult(data, "receive");
      });
    } else {
      Quagga.onDetected(data=>{
        handleScanResult(data, "use");
      });
    }
  });
}

function stopScanner(){
  try {
    Quagga.stop();
  } catch(e){}
  currentStream = null;

  // hide video windows
  $("receiveVideoWrapper").classList.add("hidden");
  $("useVideoWrapper").classList.add("hidden");
}

/********************************************
 * HANDLE SCAN RESULT (Receive + Use)
 ********************************************/
let lastScan = null;
let lastScanTime = 0;

function handleScanResult(result, mode){
  if (!result || !result.codeResult) return;
  let code = (result.codeResult.code || "").trim();

  // UPC-A leading zero fix
  if (code.length===13 && code.startsWith("0")) {
    code = code.substring(1);
  }

  // Debounce identical scans
  const now = Date.now();
  if (lastScan === code && now - lastScanTime < 800) return;
  lastScan = code;
  lastScanTime = now;

  // Confidence filter
  if (!isHighConfidence(result)) return;

  // UPC validation
  if (code.length===12 && !isValidUPC(code)) return;

  // Feedback
  vibrate();
  beep();

  if (mode==="receive") addReceiveScan(code);
  else useOne(code);
}

/********************************************
 * RECEIVE MODE
 ********************************************/
function addReceiveScan(upc){
  if (!receiveScans[upc]) receiveScans[upc] = 0;
  receiveScans[upc]++;

  const item = inventory[upc];
  if (!item) {
    // create modal for new item
    openNewItemModal(upc, receiveScans[upc]);
  }

  renderReceiveList();
}

function renderReceiveList(){
  const keys = Object.keys(receiveScans);
  if (!keys.length){
    $("receiveList").textContent = "No items scanned yet.";
    return;
  }
  $("receiveList").innerHTML = keys.map(upc=>{
    const item = inventory[upc];
    const name = item ? item.name : "(New item)";
    return `<div>${name} [${upc}] √ó ${receiveScans[upc]}</div>`;
  }).join("");
}

$("receiveApplyBtn").onclick = ()=>{
  const now = new Date().toISOString();
  for (const upc of Object.keys(receiveScans)){
    const count = receiveScans[upc];
    if (!inventory[upc]) continue;
    inventory[upc].qty = (inventory[upc].qty || 0) + count;
    inventory[upc].last_added = now;
  }
  receiveScans = {};
  saveInventory();
  renderReceiveList();
  renderInventoryTable();
};

/********************************************
 * USE MODE
 ********************************************/
function useOne(upc){
  const item = inventory[upc];
  if (!item) {
    $("useStatus").textContent = "Item not found in inventory.";
    return;
  }
  item.qty = Math.max(0, (item.qty||0)-1);
  item.last_used = new Date().toISOString();
  saveInventory();
  renderInventoryTable();

  $("useStatus").textContent = `${item.name} ‚Üí ${item.qty}`;
}
/********************************************
 * INVENTORY TABLE
 ********************************************/
$("invSearch").oninput = renderInventoryTable;

function renderInventoryTable(){
  const body = $("inventoryBody");
  const search = $("invSearch").value.trim().toLowerCase();

  const rows = Object.values(inventory);
  const filtered = rows.filter(item=>{
    return (
      (item.name||"").toLowerCase().includes(search) ||
      (item.upc||"").includes(search)
    );
  });

  if (!filtered.length){
    body.innerHTML = `<tr><td colspan="6">No items match.</td></tr>`;
    return;
  }

  filtered.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

  body.innerHTML = filtered.map(item=>{
    const q = item.qty||0;
    return `
      <tr>
        <td><strong>${item.name}</strong><br><span style="font-size:11px;">${item.size||""} ${item.unit||""}</span></td>
        <td>${item.upc}</td>
        <td>${item.category}</td>
        <td>${q}</td>
        <td>${item.par||""}</td>
        <td><button class="btn secondary" style="padding:4px 8px; font-size:11px;" onclick="openEditItemModal('${item.upc}')">Edit</button></td>
      </tr>
    `;
  }).join("");
}

/********************************************
 * ITEM MODAL (NEW + EDIT)
 ********************************************/
function openNewItemModal(upc, qty){
  $("modalTitle").textContent = "New Item";
  $("modalUpc").value = upc;
  $("modalName").value = "";
  $("modalCategory").value = "Syrup";
  $("modalSize").value = "";
  $("modalUnit").value = "bottle";
  $("modalPar").value = "";
  $("modalQty").value = qty || 1;
  $("modalNotes").value = "";
  $("modalDeleteBtn").classList.add("hidden");
  $("itemModalBackdrop").classList.remove("hidden");
}

function openEditItemModal(upc){
  const item = inventory[upc];
  if (!item) return;

  $("modalTitle").textContent = "Edit Item";
  $("modalUpc").value = item.upc;
  $("modalName").value = item.name||"";
  $("modalCategory").value = item.category||"Other";
  $("modalSize").value = item.size||"";
  $("modalUnit").value = item.unit||"";
  $("modalPar").value = item.par||"";
  $("modalQty").value = item.qty||0;
  $("modalNotes").value = item.notes||"";
  $("modalDeleteBtn").classList.remove("hidden");
  $("itemModalBackdrop").classList.remove("hidden");
}

$("modalCancelBtn").onclick = ()=> $("itemModalBackdrop").classList.add("hidden");
$("modalDeleteBtn").onclick = ()=>{
  const upc = $("modalUpc").value;
  delete inventory[upc];
  saveInventory();
  $("itemModalBackdrop").classList.add("hidden");
  renderInventoryTable();
};

$("modalSaveBtn").onclick = ()=>{
  const upc = $("modalUpc").value;
  const name = $("modalName").value.trim();
  const category = $("modalCategory").value;
  const size = $("modalSize").value.trim();
  const unit = $("modalUnit").value.trim() || "bottle";
  const par = parseInt($("modalPar").value || "0",10);
  const qty = parseInt($("modalQty").value || "0",10);
  const notes = $("modalNotes").value.trim();

  inventory[upc] = {
    upc, name, category, size, unit, par, qty, notes
  };

  saveInventory();
  $("itemModalBackdrop").classList.add("hidden");
  renderInventoryTable();
};

/********************************************
 * FLASH / TORCH
 ********************************************/
async function toggleTorch(stream){
  if (!stream) return;
  const track = stream.getVideoTracks()[0];
  const capabilities = track.getCapabilities();
  if (!capabilities.torch) return;

  const settings = track.getSettings();
  const newState = !settings.torch;

  try {
    await track.applyConstraints({
      advanced: [{ torch:newState }]
    });
  } catch(e){
    console.warn("Torch failed:", e);
  }
}

$("toggleTorchReceive").onclick = ()=> {
  if (Quagga._streams && Quagga._streams.length){
    toggleTorch(Quagga._streams[0]);
  }
};

$("toggleTorchUse").onclick = ()=> {
  if (Quagga._streams && Quagga._streams.length){
    toggleTorch(Quagga._streams[0]);
  }
};

/********************************************
 * START/STOP BUTTONS FOR RECEIVE/USE
 ********************************************/
$("startReceiveScanBtn").onclick = ()=>{
  $("startReceiveScanBtn").classList.add("hidden");
  $("stopReceiveScanBtn").classList.remove("hidden");
  startScanner($("receiveVideo"), "receive");
};

$("stopReceiveScanBtn").onclick = ()=>{
  stopScanner();
  $("startReceiveScanBtn").classList.remove("hidden");
  $("stopReceiveScanBtn").classList.add("hidden");
};

$("startUseScanBtn").onclick = ()=>{
  $("startUseScanBtn").classList.add("hidden");
  $("stopUseScanBtn").classList.remove("hidden");
  startScanner($("useVideo"), "use");
};

$("stopUseScanBtn").onclick = ()=>{
  stopScanner();
  $("startUseScanBtn").classList.remove("hidden");
  $("stopUseScanBtn").classList.add("hidden");
};

/********************************************
 * EXPORT (PDF via Print Window)
 ********************************************/
$("btnExportPDF").onclick = ()=>{
  const win = window.open("", "_blank");
  if (!win){ alert("Popup blocked"); return; }

  win.document.write(`
    <!DOCTYPE html><html><head><meta charset="UTF-8">
    <title>Brewtopia Inventory Export</title>
    <style>
      body { font-family:sans-serif; margin:20px; }
      table { width:100%; border-collapse:collapse; margin-top:20px; }
      th, td { border:1px solid #ccc; padding:6px; font-size:13px; }
      th { background:#eee; }
    </style></head><body>
    <h2>Brewtopia Inventory</h2>
    <div>Exported: ${new Date().toLocaleString()}</div>
    <table><thead>
      <tr><th>Category</th><th>Item</th><th>UPC</th><th>Size</th>
      <th>Unit</th><th>Qty</th><th>Par</th><th>Notes</th></tr>
    </thead><tbody>
  `);

  const rows = Object.values(inventory).sort((a,b)=>{
    const c = (a.category||"").localeCompare(b.category||"");
    return c!==0 ? c : (a.name||"").localeCompare(b.name||"");
  });

  for (const item of rows){
    win.document.write(`
      <tr>
        <td>${item.category||""}</td>
        <td>${item.name||""}</td>
        <td>${item.upc||""}</td>
        <td>${item.size||""}</td>
        <td>${item.unit||""}</td>
        <td>${item.qty||""}</td>
        <td>${item.par||""}</td>
        <td>${item.notes||""}</td>
      </tr>
    `);
  }

  win.document.write("</tbody></table></body></html>");
  win.document.close();
  win.focus();
  win.print();
};
/********************************************
 * EXPORT (DOWNLOAD HTML)
 ********************************************/
$("btnExportHTML").onclick = () => {
  const rows = Object.values(inventory).sort((a, b) => {
    const c = (a.category || "").localeCompare(b.category || "");
    return c !== 0 ? c : (a.name || "").localeCompare(b.name || "");
  });

  let html = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Brewtopia Inventory Export</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
  th { background: #eee; }
</style>
</head><body>
<h2>Brewtopia Inventory</h2>
<div>Exported: ${new Date().toLocaleString()}</div>
<table>
<thead>
  <tr>
    <th>Category</th><th>Item</th><th>UPC</th><th>Size</th>
    <th>Unit</th><th>Qty</th><th>Par</th><th>Notes</th>
  </tr>
</thead>
<tbody>
`;

  for (const item of rows) {
    html += `
<tr>
  <td>${item.category || ""}</td>
  <td>${item.name || ""}</td>
  <td>${item.upc || ""}</td>
  <td>${item.size || ""}</td>
  <td>${item.unit || ""}</td>
  <td>${item.qty || ""}</td>
  <td>${item.par || ""}</td>
  <td>${item.notes || ""}</td>
</tr>
`;
  }

  html += `
</tbody>
</table>
</body></html>
`;

  const blob = new Blob([html], { type: "text/html" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  const dateStr = new Date().toISOString().split("T")[0];
  a.download = `brewtopia-inventory-${dateStr}.html`;
  a.href = url;
  a.click();

  setTimeout(() => URL.revokeObjectURL(url), 1500);
};

/********************************************
 * IMPORT (HTML FILE)
 ********************************************/
$("btnImportHTML").onclick = () => {
  $("importFileInput").click();
};

$("importFileInput").onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    const html = ev.target.result;
    try {
      importInventoryFromHTML(html);
      alert("Inventory imported successfully!");
      renderInventoryTable();
    } catch (err) {
      console.error(err);
      alert("Import failed. Ensure this is a valid Brewtopia HTML export file.");
    }
  };
  reader.readAsText(file);
};

function importInventoryFromHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  const rows = doc.querySelectorAll("table tbody tr");
  if (!rows || rows.length === 0) throw new Error("No rows found.");

  const newInv = {};

  rows.forEach((tr) => {
    const tds = tr.querySelectorAll("td");
    if (tds.length < 8) return;

    const category = tds[0].textContent.trim();
    const name = tds[1].textContent.trim();
    const upc = tds[2].textContent.trim();
    const size = tds[3].textContent.trim();
    const unit = tds[4].textContent.trim();
    const qty = parseInt(tds[5].textContent.trim() || "0", 10);
    const par = parseInt(tds[6].textContent.trim() || "0", 10);
    const notes = tds[7].textContent.trim();

    if (upc) {
      newInv[upc] = {
        upc,
        name,
        category,
        size,
        unit,
        qty,
        par,
        notes,
      };
    }
  });

  inventory = newInv;
  saveInventory();
}

/********************************************
 * USB BARCODE SCANNERS (Keyboard Wedges)
 ********************************************/
document.addEventListener("keydown", handleUSBScanner);

let usbBuffer = "";
let usbTimer = null;

function handleUSBScanner(e) {
  if (e.key === "Enter") {
    const code = usbBuffer.trim();
    usbBuffer = "";

    if (code.length >= 6) {
      beep();
      vibrate();

      // UPC-A normalization: leading 0 fix
      let normalized = code;
      if (normalized.length === 13 && normalized.startsWith("0")) {
        normalized = normalized.substring(1);
      }

      // Prefer active mode
      if (!$("receiveCard").classList.contains("hidden")) {
        addReceiveScan(normalized);
        renderReceiveList();
      } else if (!$("useCard").classList.contains("hidden")) {
        useOne(normalized);
      }
    }
    return;
  }

  if (e.key.length === 1 && /\d/.test(e.key)) {
    usbBuffer += e.key;
    clearTimeout(usbTimer);
    usbTimer = setTimeout(() => (usbBuffer = ""), 1000);
  }
}

/********************************************
 * END OF SCRIPT (more coming in Part 5)
 ********************************************/
</script>
<script>
/********************************************
 * CLEANUP & FINAL BINDINGS
 ********************************************/

// Make sure inventory loads on entry after PIN unlock
document.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem(STORAGE_KEY)) {
    loadInventory();
  }
});

/********************************************
 * OPTIONAL ‚Äî SUMMARY LINE (not required)
 ********************************************/
function updateSummaryLine() {
  const items = Object.values(inventory);
  let totalQty = 0, low = 0, zero = 0;

  items.forEach(item => {
    const q = item.qty || 0;
    totalQty += q;
    if (q === 0) zero++;
    else if (item.par && q < item.par) low++;
  });

  // (Optional UI element ‚Äì add one if needed)
}

/********************************************
 * SAFETY ‚Äî close modal on escape key
 ********************************************/
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    $("itemModalBackdrop").classList.add("hidden");
  }
});

/********************************************
 * SAFETY ‚Äî stop scanner when switching tabs
 ********************************************/
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopScanner();
  }
});

/********************************************
 * ENSURE QUAGGA STREAM STOPS ON UNLOAD
 ********************************************/
window.addEventListener("beforeunload", () => {
  stopScanner();
});
</script>

</body>
</html>
