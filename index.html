<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Brewtopia Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Quagga2 -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#0d1117;color:#e6edf3;padding:16px;display:flex;justify-content:center}
.app{width:100%;max-width:920px}
.card{background:rgba(22,27,34,.92);border:1px solid #30363d;border-radius:16px;padding:16px;margin-bottom:16px}
.btn{padding:9px 14px;border-radius:999px;border:1px solid transparent;background:linear-gradient(135deg,#238636,#2ea043);color:#fff;cursor:pointer}
.btn.secondary{background:linear-gradient(135deg,#21262d,#161b22);border-color:#30363d}
.btn.danger{background:linear-gradient(135deg,#b91c1c,#ef4444)}
.hidden{display:none!important}
input,select,textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #30363d;background:#010409;color:#e6edf3}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:4px 6px;border-bottom:1px solid #30363d;text-align:left}
video{width:100%;border-radius:12px;background:#000;margin-top:10px}
.modal-backdrop{position:fixed;inset:0;background:#0008;backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:50}
.modal{background:#0d1117;border:1px solid #30363d;border-radius:14px;padding:16px;width:100%;max-width:420px}
.small{font-size:13px;color:#8b949e}
</style>
</head>
<body>
<div class="app">

<div id="loginCard" class="card">
  <h2>Brewtopia Inventory</h2>
  <label>PIN</label>
  <input id="pinInput" type="password" inputmode="numeric">
  <button class="btn" id="loginBtn">Unlock</button>
  <div id="loginStatus" class="small"></div>
</div>

<div id="mainArea" class="hidden">

<div class="card">
  <h2>Brewtopia Inventory</h2>
  <button class="btn secondary" id="lockBtn" style="float:right;margin-top:-34px">Lock</button>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:6px">
    <button class="btn" id="btnReceive">ðŸ“¦ Receive</button>
    <button class="btn secondary" id="btnUse">ðŸ¥¤ Use</button>
    <button class="btn secondary" id="btnInventory">ðŸ“‹ Inventory</button>
  </div>
  <div id="globalStatus" class="small" style="margin-top:8px"></div>
</div>

<div id="receiveCard" class="card hidden">
  <h3>Receive Stock</h3>
  <button class="btn" id="startRecvScan">Start Camera</button>
  <button class="btn secondary hidden" id="stopRecvScan">Stop</button>
  <video id="recvVideo" class="hidden"></video>
  <label>Manual / USB UPC</label>
  <input id="recvManual">
  <button class="btn secondary" id="recvManualBtn">Add</button>
</div>

<div id="useCard" class="card hidden">
  <h3>Use Item</h3>
  <button class="btn" id="startUseScan">Start Camera</button>
  <button class="btn secondary hidden" id="stopUseScan">Stop</button>
  <video id="useVideo" class="hidden"></video>
  <label>Manual / USB UPC</label>
  <input id="useManual">
  <button class="btn secondary" id="useManualBtn">Use</button>
</div>

<div id="inventoryCard" class="card hidden">
  <h3>Inventory</h3>
  <input id="invSearch" placeholder="Search">
  <table>
    <thead>
      <tr><th>Name</th><th>UPC</th><th>Brand</th><th>Office</th><th>Trailer</th><th>Caboose</th><th></th></tr>
    </thead>
    <tbody id="invBody"></tbody>
  </table>
</div>

<!-- Quantity Modal -->
<div id="qtyModal" class="modal-backdrop hidden">
  <div class="modal">
    <label>Location</label>
    <select id="qtyLoc">
      <option value="office">Office</option>
      <option value="trailer">Trailer</option>
      <option value="caboose">Caboose</option>
    </select>
    <label>Quantity</label>
    <input id="qtyNum" type="number" value="1" min="1">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn secondary" onclick="closeQty()">Cancel</button>
      <button class="btn" onclick="confirmQty()">OK</button>
    </div>
  </div>
</div>

<!-- Item Modal -->
<div id="itemModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Item Details</h3>
    <label>UPC</label><input id="mUPC" readonly>
    <label>Name</label><input id="mName">
    <label>Brand</label><input id="mBrand">
    <label>Category</label><input id="mCategory">
    <label><input type="checkbox" id="mSugar"> Sugar Free</label>
    <label>Size</label><input id="mSize">
    <label>Notes</label><textarea id="mNotes"></textarea>
    <label>Office Qty</label><input id="mQOffice" type="number">
    <label>Trailer Qty</label><input id="mQTrailer" type="number">
    <label>Caboose Qty</label><input id="mQCaboose" type="number">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn secondary" onclick="closeItem()">Cancel</button>
      <button class="btn" onclick="saveItem()">Save</button>
    </div>
  </div>
</div>

</div>
</div>

<script>
const PIN="6251";
const STORE_KEY="brewtopia_inventory_v3";
let inventory={},currentUPC="",mode="receive";

function load(){inventory=JSON.parse(localStorage.getItem(STORE_KEY)||"{}")}
function save(){localStorage.setItem(STORE_KEY,JSON.stringify(inventory))}
function setStatus(t){document.getElementById("globalStatus").textContent=t}

function cleanUPC(u){return(u||"").replace(/\D/g,"").replace(/^0+/,"")}

async function lookupOFF(upc){
  const key="off_"+upc;
  const cached=localStorage.getItem(key);
  if(cached)return JSON.parse(cached);
  try{
    const r=await fetch(`https://world.openfoodfacts.org/api/v2/product/${upc}.json`);
    const j=await r.json();
    if(!j.product)return null;
    const p=j.product;
    const data={
      name:p.product_name||"",
      brand:(p.brands||"").split(",")[0],
      size:p.quantity||"",
      sugar:/(sugar free|no sugar|sans sucre)/i.test(JSON.stringify(p)),
      notes:(p.ingredients_text||"")
    };
    localStorage.setItem(key,JSON.stringify(data));
    return data;
  }catch(e){return null}
}

function showQty(upc){currentUPC=upc;document.getElementById("qtyNum").value=1;document.getElementById("qtyModal").classList.remove("hidden")}
function closeQty(){document.getElementById("qtyModal").classList.add("hidden")}

async function confirmQty(){
  const q=parseInt(qtyNum.value)||1;
  const loc=qtyLoc.value;
  closeQty();
  if(!inventory[currentUPC]){
    openNewItem(currentUPC,q,loc);
    return;
  }
  inventory[currentUPC][loc]=(inventory[currentUPC][loc]||0)+(mode==="use"?-q:q);
  save();render();
}

async function openNewItem(upc,q,loc){
  const off=await lookupOFF(upc);
  mUPC.value=upc;
  mName.value=off?.name||"";
  mBrand.value=off?.brand||"";
  mCategory.value="";
  mSugar.checked=!!off?.sugar;
  mSize.value=off?.size||"";
  mNotes.value=off?.notes||"";
  mQOffice.value=loc==="office"?q:0;
  mQTrailer.value=loc==="trailer"?q:0;
  mQCaboose.value=loc==="caboose"?q:0;
  document.getElementById("itemModal").classList.remove("hidden");
}

function saveItem(){
  inventory[mUPC.value]={
    upc:mUPC.value,
    name:mName.value,
    brand:mBrand.value,
    category:mCategory.value,
    sugar:mSugar.checked,
    size:mSize.value,
    notes:mNotes.value,
    office:+mQOffice.value||0,
    trailer:+mQTrailer.value||0,
    caboose:+mQCaboose.value||0
  };
  save();render();closeItem()
}

function closeItem(){document.getElementById("itemModal").classList.add("hidden")}

function render(){
  const b=invBody;b.innerHTML="";
  Object.values(inventory).forEach(i=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i.name}${i.sugar?" (SF)":""}</td><td>${i.upc}</td><td>${i.brand}</td>
    <td>${i.office||0}</td><td>${i.trailer||0}</td><td>${i.caboose||0}</td>
    <td><button class="btn secondary" onclick="edit('${i.upc}')">Edit</button></td>`;
    b.appendChild(tr)
  })
}

function edit(u){
  const i=inventory[u];
  mUPC.value=u;mName.value=i.name;mBrand.value=i.brand;mCategory.value=i.category;
  mSugar.checked=i.sugar;mSize.value=i.size;mNotes.value=i.notes;
  mQOffice.value=i.office;mQTrailer.value=i.trailer;mQCaboose.value=i.caboose;
  document.getElementById("itemModal").classList.remove("hidden");
}

loginBtn.onclick=()=>{if(pinInput.value===PIN){loginCard.classList.add("hidden");mainArea.classList.remove("hidden");load();render()}}
lockBtn.onclick=()=>location.reload();

btnReceive.onclick=()=>{mode="receive";receiveCard.classList.remove("hidden");useCard.classList.add("hidden");inventoryCard.classList.add("hidden")}
btnUse.onclick=()=>{mode="use";useCard.classList.remove("hidden");receiveCard.classList.add("hidden");inventoryCard.classList.add("hidden")}
btnInventory.onclick=()=>{inventoryCard.classList.remove("hidden");receiveCard.classList.add("hidden");useCard.classList.add("hidden");render()}

recvManualBtn.onclick=()=>showQty(cleanUPC(recvManual.value));
useManualBtn.onclick=()=>showQty(cleanUPC(useManual.value));
</script>
</body>
</html>