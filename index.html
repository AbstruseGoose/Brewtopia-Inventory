<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brewtopia Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Quagga2 (WASM build) -->
  <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg-body: #0d1117;
      --bg-card: rgba(22, 27, 34, 0.92);
      --bg-card-soft: rgba(22, 27, 34, 0.6);
      --border-subtle: #30363d;
      --text-primary: #e6edf3;
      --text-muted: #8b949e;
      --accent: #2f81f7;
      --accent-soft: rgba(47, 129, 247, 0.2);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #161b22 0, #0d1117 55%, #020409 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 920px;
      margin: 0 auto;
    }

    h1, h2, h3, h4 {
      margin: 0 0 0.3rem;
      font-weight: 600;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px 18px;
      margin-bottom: 16px;
      border: 1px solid var(--border-subtle);
      box-shadow:
        0 18px 45px rgba(0, 0, 0, 0.55),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(18px);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, #238636, #2ea043);
      color: #f0fdf4;
      white-space: nowrap;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #21262d, #161b22);
      color: var(--text-primary);
      border-color: #30363d;
    }

    .btn.danger {
      background: linear-gradient(135deg, #b91c1c, #ef4444);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #010409;
      color: var(--text-primary);
      font-size: 14px;
      margin: 4px 0 10px;
    }

    .video-wrapper {
      position: relative;
      background: #010409;
      border-radius: 14px;
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid #30363d;
      min-height: 200px;
    }

    .scan-overlay {
      position: absolute;
      inset: 14%;
      border: 2px solid rgba(47, 129, 247, 0.85);
      border-radius: 14px;
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.7);
      pointer-events: none;
    }

    .hidden { display: none !important; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 4px 0; text-align: left; }

  </style>
</head>

<body>
<div class="app">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h1>Brewtopia Inventory</h1>

    <label for="pinInput">PIN</label>
    <input id="pinInput" type="password" inputmode="numeric" maxlength="6" placeholder="Enter PIN" />

    <button id="loginBtn" class="btn">Unlock</button>
    <div id="loginStatus" style="margin-top:6px;"></div>
  </div>

  <!-- MAIN -->
  <div id="mainArea" class="hidden">

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>Brewtopia Inventory</h2>
        <button id="lockBtn" class="btn secondary" style="padding:6px 14px;">Lock</button>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
        <button class="btn" id="btnReceive">üì¶ Receive Stock</button>
        <button class="btn secondary" id="btnUse">ü•§ Use Item</button>
        <button class="btn secondary" id="btnInventory">üìã Inventory</button>
        <button class="btn secondary" id="btnExport">üñ®Ô∏è Export</button>
      </div>
    </div>

    <!-- RECEIVE -->
    <div id="receiveCard" class="card hidden">
      <h3>Receive Stock</h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="startReceiveScanBtn">üé• Start Camera</button>
        <button class="btn secondary" id="stopReceiveScanBtn" disabled>Stop</button>
        <button class="btn secondary" id="receiveFlashBtn" disabled>üî¶ Flash</button>
      </div>

      <div id="receiveVideoWrapper" class="video-wrapper hidden">
        <!-- Quagga will inject a video element here -->
        <div class="scan-overlay"></div>
      </div>

      <div style="margin-top:8px;">
        <input id="receiveManualUpc" type="text" placeholder="Enter or scan UPC" />
        <button id="receiveManualBtn" class="btn secondary">Add</button>
      </div>

      <div id="receiveList" style="margin-top:12px;font-size:14px;color:#aaa;">
        No items scanned yet.
      </div>

      <button id="receiveApplyBtn" class="btn" style="margin-top:12px;" disabled>Apply</button>
      <div id="receiveStatus" style="margin-top:8px;"></div>
    </div>

    <!-- USE -->
    <div id="useCard" class="card hidden">
      <h3>Use Item</h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn" id="startUseScanBtn">üé• Start Camera</button>
        <button class="btn secondary" id="stopUseScanBtn" disabled>Stop</button>
        <button class="btn secondary" id="useFlashBtn" disabled>üî¶ Flash</button>
      </div>

      <div id="useVideoWrapper" class="video-wrapper hidden">
        <!-- Quagga will inject a video element here -->
        <div class="scan-overlay"></div>
      </div>

      <div style="margin-top:8px%;">
        <input id="useManualUpc" type="text" placeholder="Enter or scan UPC" />
        <button id="useManualBtn" class="btn secondary">Use 1</button>
      </div>

      <div id="useStatus" style="margin-top:8px;"></div>
    </div>

    <!-- INVENTORY -->
    <div id="inventoryCard" class="card hidden">
      <h3>Inventory</h3>

      <input id="invSearch" type="text" placeholder="Search items‚Ä¶" />

      <table style="margin-top:12px;">
        <thead>
          <tr>
            <th>Item</th>
            <th>UPC</th>
            <th>Category</th>
            <th>Qty</th>
            <th>Par</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
      </table>

      <div id="inventoryStatus" style="margin-top:8px;color:#8b949e;"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="itemModalBackdrop" class="hidden" style="
    position:fixed;inset:0;background:rgba(0,0,0,0.55);
    display:flex;justify-content:center;align-items:center;
    z-index:999;">
    <div style="
      width:100%;max-width:480px;
      background:#111;
      border-radius:14px;
      padding:16px;border:1px solid #333;
      box-shadow:0 8px 28px rgba(0, 0, 0, 0.6);">

      <h3 id="modalTitle">New Item</h3>
      <div id="modalSubtitle" style="font-size:13px;color:#aaa;margin-bottom:8px;"></div>

      <label>UPC</label>
      <input id="modalUpc" type="text" readonly />

      <label>Name</label>
      <input id="modalName" type="text" placeholder="e.g. Vanilla Syrup" />

      <label>Category</label>
      <select id="modalCategory">
        <option value="Syrup">Syrup</option>
        <option value="Milk">Milk</option>
        <option value="Topping">Topping</option>
        <option value="Cup">Cup</option>
        <option value="Other">Other</option>
      </select>

      <label>Size</label>
      <input id="modalSize" type="text" placeholder="750ml, gallon, etc" />

      <label>Unit</label>
      <input id="modalUnit" type="text" placeholder="bottle, jug, case‚Ä¶" />

      <label>Par</label>
      <input id="modalPar" type="number" min="0" placeholder="6" />

      <label>Quantity</label>
      <input id="modalQty" type="number" min="0" placeholder="1" />

      <label>Notes</label>
      <textarea id="modalNotes" rows="2" placeholder="Optional notes"></textarea>

      <div style="display:flex;justify-content:space-between;margin-top:14px;">
        <button id="modalDeleteBtn" class="btn danger hidden">Delete</button>
        <div>
          <button id="modalCancelBtn" class="btn secondary">Cancel</button>
          <button id="modalSaveBtn" class="btn">Save</button>
        </div>
      </div>

      <div id="modalStatus" style="margin-top:8px;"></div>
    </div>
  </div>

</div> <!-- end .app -->

<script>
/*********************************************************
 * CONFIG
 *********************************************************/
const PIN = "6251";
const STORAGE_KEY = "brewtopia_inventory_localcache_v1";

/*********************************************************
 * STATE
 *********************************************************/
let inventory = {};        // full inventory
let receiveScans = {};     // UPC ‚Üí count (Receive Stock)

let quaggaRunning = false;
let quaggaMode = null;     // "receive" or "use"

let lastScanCode = null;
let lastScanTime = 0;
const SCAN_COOLDOWN = 800; // ms

let receiveTorchOn = false;
let useTorchOn = false;

/*********************************************************
 * ELEMENTS
 *********************************************************/
const loginCard = document.getElementById("loginCard");
const mainArea = document.getElementById("mainArea");
const pinInput = document.getElementById("pinInput");
const loginBtn = document.getElementById("loginBtn");
const loginStatus = document.getElementById("loginStatus");
const lockBtn = document.getElementById("lockBtn");

const btnReceive = document.getElementById("btnReceive");
const btnUse = document.getElementById("btnUse");
const btnInventory = document.getElementById("btnInventory");
const btnExport = document.getElementById("btnExport");

const receiveCard = document.getElementById("receiveCard");
const useCard = document.getElementById("useCard");
const inventoryCard = document.getElementById("inventoryCard");

const startReceiveScanBtn = document.getElementById("startReceiveScanBtn");
const stopReceiveScanBtn = document.getElementById("stopReceiveScanBtn");
const receiveFlashBtn = document.getElementById("receiveFlashBtn");
const receiveVideoWrapper = document.getElementById("receiveVideoWrapper");
const receiveManualUpc = document.getElementById("receiveManualUpc");
const receiveManualBtn = document.getElementById("receiveManualBtn");
const receiveList = document.getElementById("receiveList");
const receiveApplyBtn = document.getElementById("receiveApplyBtn");
const receiveStatus = document.getElementById("receiveStatus");

const startUseScanBtn = document.getElementById("startUseScanBtn");
const stopUseScanBtn = document.getElementById("stopUseScanBtn");
const useFlashBtn = document.getElementById("useFlashBtn");
const useVideoWrapper = document.getElementById("useVideoWrapper");
const useManualUpc = document.getElementById("useManualUpc");
const useManualBtn = document.getElementById("useManualBtn");
const useStatus = document.getElementById("useStatus");

const invSearch = document.getElementById("invSearch");
const inventoryBody = document.getElementById("inventoryBody");
const inventoryStatus = document.getElementById("inventoryStatus");

const itemModalBackdrop = document.getElementById("itemModalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const modalSubtitle = document.getElementById("modalSubtitle");
const modalUpc = document.getElementById("modalUpc");
const modalName = document.getElementById("modalName");
const modalCategory = document.getElementById("modalCategory");
const modalSize = document.getElementById("modalSize");
const modalUnit = document.getElementById("modalUnit");
const modalPar = document.getElementById("modalPar");
const modalQty = document.getElementById("modalQty");
const modalNotes = document.getElementById("modalNotes");
const modalSaveBtn = document.getElementById("modalSaveBtn");
const modalCancelBtn = document.getElementById("modalCancelBtn");
const modalDeleteBtn = document.getElementById("modalDeleteBtn");
const modalStatus = document.getElementById("modalStatus");

/*********************************************************
 * UTIL
 *********************************************************/
function setStatus(el, msg, good = false) {
  el.textContent = msg;
  el.style.color = good ? "#4ade80" : "#f87171";
}

function beep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.frequency.value = 880;
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.15);
  } catch (e) {}
}

function vibrate() {
  if (navigator.vibrate) navigator.vibrate(70);
}

/*********************************************************
 * LOGIN
 *********************************************************/
loginBtn.addEventListener("click", () => {
  if (pinInput.value.trim() === PIN) {
    loginCard.classList.add("hidden");
    mainArea.classList.remove("hidden");
    loadInventoryLocal();
    renderInventoryTable();
  } else {
    setStatus(loginStatus, "Incorrect PIN");
  }
});

lockBtn.addEventListener("click", () => {
  mainArea.classList.add("hidden");
  loginCard.classList.remove("hidden");
});

/*********************************************************
 * LOCAL STORAGE CACHE
 *********************************************************/
function loadInventoryLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    inventory = {};
    return;
  }
  try {
    inventory = JSON.parse(raw);
  } catch {
    inventory = {};
  }
}

function saveInventoryLocal() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory));
}

/*********************************************************
 * NAVIGATION
 *********************************************************/
btnReceive.addEventListener("click", () => showSection("receive"));
btnUse.addEventListener("click", () => showSection("use"));
btnInventory.addEventListener("click", () => showSection("inventory"));

function showSection(name) {
  receiveCard.classList.add("hidden");
  useCard.classList.add("hidden");
  inventoryCard.classList.add("hidden");

  stopQuagga();

  if (name === "receive") receiveCard.classList.remove("hidden");
  if (name === "use") useCard.classList.remove("hidden");
  if (name === "inventory") inventoryCard.classList.remove("hidden");

  if (name === "inventory") renderInventoryTable();
}

/*********************************************************
 * RECEIVE STOCK
 *********************************************************/
function addReceiveScan(upc) {
  if (!upc) return;
  upc = upc.trim();

  const existing = inventory[upc];

  if (!existing) {
    openNewItem(upc, 1);
    return;
  }

  receiveScans[upc] = (receiveScans[upc] || 0) + 1;
  beep();
  vibrate();
  renderReceiveList();
}

function renderReceiveList() {
  const keys = Object.keys(receiveScans);
  if (!keys.length) {
    receiveList.textContent = "No items scanned yet.";
    receiveApplyBtn.disabled = true;
    return;
  }

  receiveApplyBtn.disabled = false;

  receiveList.innerHTML = keys
    .map(upc => {
      const item = inventory[upc];
      return `<div>- <strong>${item?.name || "(Unnamed item)"}</strong> [${upc}] √ó ${receiveScans[upc]}</div>`;
    })
    .join("");
}

receiveManualBtn.addEventListener("click", () => {
  const upc = receiveManualUpc.value;
  addReceiveScan(upc);
  receiveManualUpc.value = "";
});

/*********************************************************
 * APPLY RECEIVE
 *********************************************************/
receiveApplyBtn.addEventListener("click", () => {
  const now = new Date().toISOString();

  Object.keys(receiveScans).forEach(upc => {
    const item = inventory[upc];
    if (!item) return;
    item.qty = Number(item.qty || 0) + receiveScans[upc];
    item.last_added = now;
  });

  receiveScans = {};
  saveInventoryLocal();
  renderReceiveList();
  renderInventoryTable();

  setStatus(receiveStatus, "Inventory updated.", true);
});

/*********************************************************
 * USE ITEM
 *********************************************************/
function useOne(upc) {
  if (!upc) return;
  upc = upc.trim();

  const item = inventory[upc];
  if (!item) {
    setStatus(useStatus, "Unknown UPC ‚Äî scan into Receive Stock first.");
    return;
  }

  const before = Number(item.qty || 0);
  const after = Math.max(0, before - 1);
  item.qty = after;
  item.last_used = new Date().toISOString();

  saveInventoryLocal();
  renderInventoryTable();

  beep();
  vibrate();

  if (after === 0) {
    setStatus(useStatus, `${item.name} is now OUT of stock.`);
  } else {
    setStatus(useStatus, `${item.name} ‚Üí ${after}`, true);
  }
}

useManualBtn.addEventListener("click", () => {
  const upc = useManualUpc.value;
  useOne(upc);
  useManualUpc.value = "";
});

/*********************************************************
 * QUAGGA2 ‚Äî SHARED SCANNER
 *********************************************************/
function getQuaggaConfig(mode) {
  const target = mode === "receive" ? receiveVideoWrapper : useVideoWrapper;
  return {
    inputStream: {
      type: "LiveStream",
      target: target,
      constraints: {
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    },
    numOfWorkers: navigator.hardwareConcurrency
      ? Math.min(4, navigator.hardwareConcurrency)
      : 2,
    locator: {
      patchSize: "medium",
      halfSample: false
    },
    decoder: {
      readers: [
        "upc_reader",
        "upc_e_reader",
        "ean_reader",
        "ean_8_reader",
        "code_128_reader",
        "code_39_reader",
        "code_93_reader",
        "itf_reader"
      ]
    },
    locate: true
  };
}

function handleQuaggaDetected(result) {
  if (!result || !result.codeResult || !result.codeResult.code) return;
  const code = result.codeResult.code.trim();
  const now = Date.now();

  if (!code) return;

  if (code === lastScanCode && now - lastScanTime < SCAN_COOLDOWN) {
    return; // debounce duplicates
  }

  lastScanCode = code;
  lastScanTime = now;

  if (quaggaMode === "receive") {
    addReceiveScan(code);
  } else if (quaggaMode === "use") {
    useOne(code);
  }
}

function startQuagga(mode) {
  if (quaggaRunning) return;
  if (!window.Quagga) {
    if (mode === "receive") setStatus(receiveStatus, "Quagga2 not loaded.", false);
    else setStatus(useStatus, "Quagga2 not loaded.", false);
    return;
  }

  quaggaMode = mode;
  const config = getQuaggaConfig(mode);

  Quagga.init(config, err => {
    if (err) {
      console.error(err);
      if (mode === "receive") setStatus(receiveStatus, "Camera error: " + err.message, false);
      else setStatus(useStatus, "Camera error: " + err.message, false);
      return;
    }

    Quagga.start();
    quaggaRunning = true;
    Quagga.onDetected(handleQuaggaDetected);

    if (mode === "receive") {
      receiveVideoWrapper.classList.remove("hidden");
      startReceiveScanBtn.disabled = true;
      stopReceiveScanBtn.disabled = false;
      receiveFlashBtn.disabled = false;
      setStatus(receiveStatus, "Camera active. Scan items as they arrive.", true);
    } else {
      useVideoWrapper.classList.remove("hidden");
      startUseScanBtn.disabled = true;
      stopUseScanBtn.disabled = false;
      useFlashBtn.disabled = false;
      setStatus(useStatus, "Camera active. Scan empties before tossing.", true);
    }
  });
}

function stopQuagga() {
  if (!quaggaRunning) return;

  Quagga.offDetected(handleQuaggaDetected);
  Quagga.stop();
  quaggaRunning = false;
  quaggaMode = null;
  lastScanCode = null;

  receiveVideoWrapper.classList.add("hidden");
  useVideoWrapper.classList.add("hidden");

  startReceiveScanBtn.disabled = false;
  stopReceiveScanBtn.disabled = true;
  receiveFlashBtn.disabled = true;
  receiveTorchOn = false;

  startUseScanBtn.disabled = false;
  stopUseScanBtn.disabled = true;
  useFlashBtn.disabled = true;
  useTorchOn = false;
}

/*********************************************************
 * FLASH / TORCH CONTROL (where supported)
 *********************************************************/
async function toggleTorch(mode) {
  if (!quaggaRunning) return;

  const track = Quagga.CameraAccess &&
                Quagga.CameraAccess.getActiveTrack &&
                Quagga.CameraAccess.getActiveTrack();
  if (!track || !track.getCapabilities) {
    if (mode === "receive") setStatus(receiveStatus, "Flash not supported on this device.", false);
    else setStatus(useStatus, "Flash not supported on this device.", false);
    return;
  }

  const caps = track.getCapabilities();
  if (!caps.torch) {
    if (mode === "receive") setStatus(receiveStatus, "Flash not supported on this device.", false);
    else setStatus(useStatus, "Flash not supported on this device.", false);
    return;
  }

  const newState = mode === "receive" ? !receiveTorchOn : !useTorchOn;

  try {
    await track.applyConstraints({ advanced: [{ torch: newState }] });
    if (mode === "receive") {
      receiveTorchOn = newState;
      setStatus(receiveStatus, newState ? "Flash ON" : "Flash OFF", true);
    } else {
      useTorchOn = newState;
      setStatus(useStatus, newState ? "Flash ON" : "Flash OFF", true);
    }
  } catch (e) {
    console.error("Torch error", e);
    if (mode === "receive") setStatus(receiveStatus, "Unable to toggle flash.", false);
    else setStatus(useStatus, "Unable to toggle flash.", false);
  }
}

/*********************************************************
 * START/STOP SCANNERS
 *********************************************************/
startReceiveScanBtn.addEventListener("click", () => startQuagga("receive"));
stopReceiveScanBtn.addEventListener("click", stopQuagga);
receiveFlashBtn.addEventListener("click", () => toggleTorch("receive"));

startUseScanBtn.addEventListener("click", () => startQuagga("use"));
stopUseScanBtn.addEventListener("click", stopQuagga);
useFlashBtn.addEventListener("click", () => toggleTorch("use"));

/*********************************************************
 * INVENTORY TABLE RENDERING
 *********************************************************/
function inventoryArray() {
  return Object.values(inventory || {});
}

function renderInventoryTable() {
  const rows = inventoryArray().sort((a, b) =>
    (a.name || "").localeCompare(b.name || "")
  );

  const search = invSearch.value.trim().toLowerCase();
  const filtered = rows.filter(item =>
    !search ||
    (item.name || "").toLowerCase().includes(search) ||
    (item.upc || "").includes(search)
  );

  inventoryBody.innerHTML = "";

  if (!filtered.length) {
    inventoryBody.innerHTML =
      "<tr><td colspan='6' style='color:#888;'>No items found.</td></tr>";
    inventoryStatus.textContent = "";
    return;
  }

  let total = 0;

  filtered.forEach(item => {
    total += Number(item.qty || 0);

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${item.name || "(unnamed)"}</td>
      <td>${item.upc}</td>
      <td>${item.category}</td>
      <td>${item.qty}</td>
      <td>${item.par || ""}</td>
      <td><button class="btn secondary" style="padding:4px 10px;font-size:12px;" data-edit="${item.upc}">Edit</button></td>
    `;

    inventoryBody.appendChild(tr);
  });

  inventoryStatus.textContent =
    `${filtered.length} items ‚Ä¢ ${total} units`;
}

invSearch.addEventListener("input", renderInventoryTable);

/*********************************************************
 * MODAL: NEW / EDIT ITEM
 *********************************************************/
function openNewItem(upc, initialQty = 1) {
  modalTitle.textContent = "New Item";
  modalSubtitle.textContent = "We‚Äôve never seen this UPC before. Fill it out once and we‚Äôll remember it.";
  modalUpc.value = upc;
  modalName.value = "";
  modalCategory.value = "Syrup";
  modalSize.value = "";
  modalUnit.value = "bottle";
  modalPar.value = "";
  modalQty.value = String(initialQty || 1);
  modalNotes.value = "";
  modalDeleteBtn.classList.add("hidden");
  modalStatus.textContent = "";
  itemModalBackdrop.classList.remove("hidden");
  modalMode = "create";
  modalUpcCurrent = upc;
}

function openEditItem(upc) {
  const item = inventory[upc];
  if (!item) return;

  modalTitle.textContent = "Edit Item";
  modalSubtitle.textContent = "Adjust name, category, par level or quantity as needed.";
  modalUpc.value = upc;
  modalName.value = item.name || "";
  modalCategory.value = item.category || "Other";
  modalSize.value = item.size || "";
  modalUnit.value = item.unit || "";
  modalPar.value = item.par != null ? String(item.par) : "";
  modalQty.value = item.qty != null ? String(item.qty) : "";
  modalNotes.value = item.notes || "";
  modalDeleteBtn.classList.remove("hidden");
  modalStatus.textContent = "";
  itemModalBackdrop.classList.remove("hidden");
  modalMode = "edit";
  modalUpcCurrent = upc;
}

function closeItemModal() {
  itemModalBackdrop.classList.add("hidden");
}

modalCancelBtn.addEventListener("click", closeItemModal);

modalSaveBtn.addEventListener("click", () => {
  const upc = (modalUpc.value || "").trim();
  const name = modalName.value.trim();
  const category = modalCategory.value;
  const size = modalSize.value.trim();
  const unit = modalUnit.value.trim() || "bottle";
  const par = modalPar.value ? Number(modalPar.value) : 0;
  const qty = modalQty.value ? Math.max(0, Number(modalQty.value)) : 0;
  const notes = modalNotes.value.trim();

  if (!upc) {
    setStatus(modalStatus, "UPC missing");
    return;
  }
  if (!name) {
    setStatus(modalStatus, "Give the item a name");
    return;
  }

  const now = new Date().toISOString();

  if (modalMode === "create") {
    inventory[upc] = {
      upc,
      name,
      category,
      size,
      unit,
      par,
      qty,
      notes,
      last_added: now,
      last_used: ""
    };
  } else {
    const item = inventory[upc] || { upc };
    item.name = name;
    item.category = category;
    item.size = size;
    item.unit = unit;
    item.par = par;
    item.qty = qty;
    item.notes = notes;
    inventory[upc] = item;
  }

  saveInventoryLocal();
  renderInventoryTable();
  renderReceiveList();
  setStatus(modalStatus, "Saved", true);

  setTimeout(() => {
    closeItemModal();
  }, 200);
});

modalDeleteBtn.addEventListener("click", () => {
  if (!modalUpcCurrent) return;
  if (!confirm("Remove this item from inventory on this device?")) return;

  delete inventory[modalUpcCurrent];
  saveInventoryLocal();
  renderInventoryTable();
  closeItemModal();
});

/*********************************************************
 * INVENTORY EDIT BUTTON HANDLER
 *********************************************************/
inventoryBody.addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-edit]");
  if (!btn) return;
  const upc = btn.getAttribute("data-edit");
  if (!upc) return;
  openEditItem(upc);
});

/*********************************************************
 * EXPORT / PRINT
 *********************************************************/
btnExport.addEventListener("click", () => {
  const rows = inventoryArray().sort((a, b) =>
    (a.category || "").localeCompare(b.category || "") ||
    (a.name || "").localeCompare(b.name || "")
  );

  const now = new Date();
  const win = window.open("", "_blank");
  if (!win) {
    alert("Popup blocked. Allow popups for this site to export/print.");
    return;
  }

  win.document.write("<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Brewtopia Inventory Export</title>");
  win.document.write("<style>");
  win.document.write(`
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 20px; color: #111827; }
    h1 { margin: 0 0 4px; }
    .muted { color: #6b7280; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
    th, td { border: 1px solid #d1d5db; padding: 6px 4px; text-align: left; }
    th { background: #f3f4f6; font-size: 12px; }
    tr:nth-child(even) td { background: #f9fafb; }
  `);
  win.document.write("</style></head><body>");

  win.document.write("<h1>Brewtopia Inventory</h1>");
  win.document.write(`<div class="muted">Exported ${now.toLocaleString()}</div>`);
  win.document.write("<table><thead><tr>");
  win.document.write("<th>Category</th><th>Item</th><th>UPC</th><th>Size</th><th>Unit</th><th>Qty</th><th>Par</th><th>Notes</th>");
  win.document.write("</tr></thead><tbody>");

  if (!rows.length) {
    win.document.write("<tr><td colspan='8'>No items in inventory.</td></tr>");
  } else {
    rows.forEach(item => {
      win.document.write("<tr>");
      win.document.write(`<td>${item.category || ""}</td>`);
      win.document.write(`<td>${item.name || ""}</td>`);
      win.document.write(`<td>${item.upc || ""}</td>`);
      win.document.write(`<td>${item.size || ""}</td>`);
      win.document.write(`<td>${item.unit || ""}</td>`);
      win.document.write(`<td>${item.qty != null ? item.qty : ""}</td>`);
      win.document.write(`<td>${item.par != null ? item.par : ""}</td>`);
      win.document.write(`<td>${item.notes || ""}</td>`);
      win.document.write("</tr>");
    });
  }

  win.document.write("</tbody></table></body></html>");
  win.document.close();
  win.focus();
  win.print();
});

/*********************************************************
 * USB BARCODE SCANNER SUPPORT
 *********************************************************/
let scanBuffer = "";
let lastCharTime = 0;
const SCAN_TIMEOUT = 80; // ms between characters to count as one scan

window.addEventListener("keydown", (e) => {
  const active = document.activeElement;
  if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA")) {
    return;
  }

  const now = Date.now();

  if (now - lastCharTime > SCAN_TIMEOUT) {
    scanBuffer = "";
  }
  lastCharTime = now;

  if (/^[0-9]$/.test(e.key)) {
    scanBuffer += e.key;
    return;
  }

  if (e.key === "Enter") {
    const upc = scanBuffer.trim();
    scanBuffer = "";
    if (!upc) return;

    const inReceive = !receiveCard.classList.contains("hidden");
    const inUse = !useCard.classList.contains("hidden");

    if (inReceive) {
      addReceiveScan(upc);
    } else if (inUse) {
      useOne(upc);
    }

    e.preventDefault();
  }
});
</script>
</body>
</html>
